---
layout:     post

title:      "使用服务网格和 Envoy 网关构建客户端的可用性和弹性"
subtitle:   ""
description: "？"
author: "Zack Butcher (译)"
date: 2024-03-25
image: "https://images.pexels.com/photos/3861972/pexels-photo-3861972.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2"
published: false
tags:
categories:
    - Tech
    - Envoy Gateway
    - Envoy
    - Service Mesh
showtoc: true
---

** 如何思考客户端应用程序中的可用性和弹性

> 这是一系列关于 Envoy 网关价值的文章之一，该网关已经达到了1.0版本的发布里程碑，并且准备投入生产使用。

通常，当我们谈论可用性和弹性时，我们是从基础设施和服务的角度来谈论的。我们很少谈论可以在客户端采取什么行动来增加后端服务的“实际感知可用性”（由客户端测量的服务的可用性）。大多数情况下，这是因为我们无法控制客户端与服务的交互方式导致的，但实际上我们可以对此进行控制,从而提交客户端的“实际感知可用性”。

在本文中，我们将讨论服务网格如何通过六种方式提高客户端对服务的“感知可用性”，从而增强系统的整体弹性：

1. 客户端负载均衡
2. 重试
3. 超时
4. 断路器
5. 异常检测
6. 限流

我们将依次介绍每种功能及其提供的价值，但需要注意的是，虽然每种功能单独提供了一些好处，但只有它们的共同作用，才能为真正地为我们的系统提高可用性。

** 每个服务都有一个“网关”

我们可以在入口或 API 网关处控制“客户端”的行为。我们可以使用该网关保护我们的内部系统免受外部发生的任何异常情况的影响。并且在该网关处，我们可以实现诸如负载均衡、重试、超时、速率限制等众所周知的模式。随着服务网格的引入，我们在基础设施中为每个服务都部署了一个“网关”——服务网格的边车。边车不仅在服务器端起作用，提供（m）TLS 和策略执行点。它还在客户端（调用者）端提供了重要的功能。由于网格提供了集中式控制，服务所有者可以轻松地为调用其服务的客户端设置默认行为。因此，我们不再只是从基础设施故障域、数据库影响范围等服务角度来讨论系统的弹性，还可以从客户端如何与服务器通信的角度进行讨论。

边车为客户端带来的第一个最重要的功能是客户端负载均衡。也就是说，与其通过中央负载均衡器（如F5）访问后端服务，不如让边车直接了解客户端可能要与之通信的每个服务实例，并直接在它们之间进行流量负载均衡。该模式直接从客户端到服务器，而无需中间人。由于我们在客户端处理负载均衡，网格还可以提供一系列其他强大的工具。

** 以三个九的价格获得五个九的高可用能力：一个真实的案例

为了提供一些关于这些工具改善应用程序的感知可用性能力的真实证据，我们可以看一下我之前在上一个雇主那里工作过的一个服务。该服务主要方法的宣传 SLA 是5.5-9秒：“五个半九”或10毫秒内达到90％（第90百分位）或更少的可用性为99.9995％。 （习惯于使用高可用性系统的人会意识到实现这种稳定运行时间所需的成本。对于不了解的人，我使用的经验法则是：“从1000美元开始，每增加一个9，就增加一个零”。当然，可以更便宜地完成，但如果要维持这种稳定运行时间一段时间（多年），那么大概就是要考虑的正确规模。）

与其为了处理任意客户端的这种可用性而构建出一个服务器能力，我们构建了一个提供网格边车提供的所有功能的厚客户端。使用该客户端的重试、超时、异常检测、断路器——以及一些高级模式，如请求hedging——我们能够交付一个感知可用性满足我们目标的系统，而后端本身则提供了略高于3.5-9秒（99.95％）的可用性。由于我们能够隔离我们的故障域，并结合智能客户端行为，我们可以使请求的失败“看起来”是不相关的。

使用服务网格进行客户端负载均衡：超越各自的总和
客户端负载均衡，以及它意味着的服务发现，意味着客户端知道它们可以与之通信的所有可能的后端，并且可以在尝试联系该服务时自由选择其中一个。我们可以使用各种算法来选择要负载平衡的端点。在这个基本功能上，我们可以建立我们列表中的其他功能。

重试
重试有助于减轻短暂故障的影响。在存在不稳定性、不可靠网络、服务器过载和故障等情况下，重试使我们有能力尝试使用不同的后端来处理同一请求，希望故障是不相关的，并且重试有可能成功。重要的是，Envoy避免将重试请求重新发送到任何已经失败的后端——假设有足够多的后端部署，我们保证会得到一个新的后端服务作为我们的目标。然而，盲目地重试会导致问题，下面的两个功能可以帮助解决这个问题。

异常检测
异常检测是一种被动健康检查形式，意味着观察每个单独的端点如何响应来自客户端的请求，并标记那些与其他端点相比表现不佳的端点（例如，连续返回错误或反复超时的端点）。如果一个端点持续表现不佳，我们将将其从活动负载平衡集中移除——换句话说，Envoy将暂时停止向其发送流量。根据一个策略，Envoy将逐步尝试向先前表现不佳的端点发送流量，以查看它们是否恢复正常。如果它们恢复正常，它们将被放回到活动负载平衡集中，并被视为正常。

当我们将异常检测与重试结合在一起时，对于单个请求，我们可以避免向已知的不良端点重试，并且在所有请求的集合中，客户端可以了解哪些端点行为良好，哪些不良，并更倾向于向行为良好的端点发送流量。

断路器
断路器有助于限制每个客户端到每个后端的最大并发性——由于所有这些重试正在进行，因此使用断路器来避免由于大量重试而导致的级联故障至关重要！断路器限制并发性，包括连接的生存时间、客户端和每个后端服务器之间的最大TCP连接数、每个个体后端服务器上允许的最大HTTP请求数量等等。当一个端点“触发断路器”（这就是它的名称），它会触发该端点的异常检测，将其移出活动负载平衡集。

因此，当我们将重试、异常检测和断路器三者结合在一起时，我们得到了一个强大的客户端，可以继续将流量转发到正常工作的后端，并避免不良行为的后端，同时不会超载系统并导致不同类型的故障。

超时
这些重试的进行也会对系统产生更重的资源负担——即使最终服务器失败，服务器也会接受请求并开始处理请求需要资源！因此，限制系统的行为变得非常重要：不仅限制用户可能遇到的最坏延迟，还限制了太多请求在流程中使用的资源（当请求超时时，Envoy可以选择执行关闭到服务器的连接等操作，表示应该停止“浪费”请求的工作）。超时帮助我们通过限制任何客户端等待服务器响应的时间（总体和每次重试）来限制系统的资源利用。一旦超时时间到达，Envoy将关闭连接并向调用方返回超时错误，释放客户端的资源（以及适当编写的服务器运行时的资源）。

速率限制
虽然超时有助于限制我们在任一请求上花费的资源，但速率限制有助于限制系统中同时存在的请求总数。您可以将超时和重试视为控制系统的深度（您等待或为任一请求支付的费用），并将速率限制视为控制系统的宽度（您一次服务的请求量）。速率限制旨在保护服务器不会被总体上的一组客户端压垮，而断路器则有助于保护服务器不会被特定的单个客户端压垮。

可以将速率限制视为保护服务器的共享资源免受过载的影响，而断路器则保护服务器的每个单个实例免受过载的影响。

Envoy支持进行本地速率限制，其中每个个体的Envoy实例跟踪其看到的请求并应用速率限制。这可以作为一种尽力而为的工具，在部署Envoy作为入口网关的地方是非常有用的。要获得“全局”速率限制，其中限制由所有Envoy实例共享，您需要部署一个存储速率限制的Redis实例，以及一个位于其前面的假服务端。Tetrate Enterprise Gateway for Envoy（TEG）—Tetrate针对Envoy Gateway的企业级分发—将它们捆绑在一起，并在其Helm图中将它们连接起来。

在拥有无状态服务执行工作并向客户端返回结果的情况下，您通常可以在不使用速率限制及其额外机制的情况下取得很大进展。

低成本下的高感知可用性
通过以上列表，我希望您能清楚地理解为什么我们需要一起讨论所有这些功能，而不是单独讨论其中任何一个。思考您系统中的不同故障模式和资源约束，并构建一套全面的客户端策略——结果可能是以较低的成本获得显著提高的客户端感知可用性。

下一步
Envoy网关（EG）是由Envoy社区推动的项目，旨在使Envoy易于用于入口。它专注于易用性，并使常见情况变得容易，并利用Kubernetes Gateway API来管理Envoy和公开应用程序。Tetrate帮助启动了EG项目，并继续大力投入其中。

Tetrate提供了一款企业级的Envoy网关分发产品——Tetrate Enterprise Gateway for Envoy——您可以立即开始使用。查看文档以了解更多信息并试用一下 ›

Envoy网关 ›
Tetrate Enterprise Gateway for Envoy ›
联系我们进行演示 ›
